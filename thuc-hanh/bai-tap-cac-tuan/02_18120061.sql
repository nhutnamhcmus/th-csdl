USE master
GO 
IF DB_ID('QLCAKHUC') IS NOT NULL
	DROP DATABASE QLCAKHUC
GO 
CREATE DATABASE QLCAKHUC
GO 
USE QLCAKHUC
-----------------------------------------------------------
-- Bước 1 : TẠO BẢNG VÀ KHÓA CHÍNH
-----------------------------------------------------------
-- KHỞI TẠO BẢNG TACGIA
CREATE TABLE TACGIA(
	MATACGIA CHAR(4),
	TENTACGIA NVARCHAR(30),
	PHAI NVARCHAR(3)

	CONSTRAINT PK_TACGIA
	PRIMARY KEY (MATACGIA)
)
-- KHỞI TẠO BẢNG CAKHUC
CREATE TABLE CAKHUC(
	MACAKHUC CHAR(4),
	TENCAKHUC NVARCHAR(30),
	THELOAI NVARCHAR(20),
	MATACGIA CHAR(4),
	THOIGIANSANGTAC DATE
	
	CONSTRAINT PK_CAKHUC
	PRIMARY KEY (MACAKHUC)
)
-- KHỞI TẠO BẢNG LOIVIET
CREATE TABLE LOIVIET(
	MACAKHUC CHAR(4),
	TUALOIVIET NVARCHAR(20),
	DICHBOI CHAR(4),
	THOIGIANDICH DATE

	CONSTRAINT PK_LOIVIET
	PRIMARY KEY (MACAKHUC, TUALOIVIET)
)
-- KHỞI TẠO BẢNG TRINHBAY
CREATE TABLE TRINHBAY(
	MACAKHUC CHAR(4),
	TUALOIVIET NVARCHAR(20),
	TENCASI NVARCHAR(30)

	CONSTRAINT PK_TRINHBAY
	PRIMARY KEY (MACAKHUC, TUALOIVIET, TENCASI)
)
-----------------------------------------------------------
-- Bước 2 : TẠO KHÓA NGOẠI
-----------------------------------------------------------
ALTER TABLE dbo.CAKHUC
ADD 
	CONSTRAINT FK_CAKHUC_TACGIA
	FOREIGN KEY (MATACGIA)
	REFERENCES dbo.TACGIA(MATACGIA)

ALTER TABLE dbo.LOIVIET
ADD 
	CONSTRAINT FK_LOIVIET_TACGIA
	FOREIGN KEY (DICHBOI)
	REFERENCES dbo.TACGIA(MATACGIA)

ALTER TABLE dbo.LOIVIET
ADD 
	CONSTRAINT FK_LOIVIET_CAKHUC
	FOREIGN KEY (MACAKHUC)
	REFERENCES dbo.CAKHUC(MACAKHUC)

ALTER TABLE dbo.TRINHBAY
ADD
	CONSTRAINT FK_TRINHBAY_LOIVIET
	FOREIGN KEY (MACAKHUC, TUALOIVIET)
	REFERENCES dbo.LOIVIET(MACAKHUC, TUALOIVIET)

-----------------------------------------------------------
-- Bước 3 : TẠO RÀNG BUỘC 
-----------------------------------------------------------
ALTER TABLE dbo.CAKHUC
ADD CONSTRAINT UK_CK_MACK
	UNIQUE(MACAKHUC)

ALTER TABLE dbo.TACGIA
ADD CONSTRAINT UK_TG_MATG
	UNIQUE(MATACGIA)

-- -- Phái chỉ có Nam, Nữ.
ALTER TABLE dbo.TACGIA
ADD CONSTRAINT C_PHAI_TACGIA
CHECK (PHAI IN ('Nam', N'Nữ'))

-- BÀI TẬP NHẬP LIỆU
INSERT [dbo].[TACGIA] ([MATACGIA], [TENTACGIA], [PHAI]) VALUES (N'0001', N'Barry Mason', N'Nam')
INSERT [dbo].[TACGIA] ([MATACGIA], [TENTACGIA], [PHAI]) VALUES (N'0002', N'Teijo', N'Nữ')
INSERT [dbo].[TACGIA] ([MATACGIA], [TENTACGIA], [PHAI]) VALUES (N'0003', N' Ranis', N'Nam')
INSERT [dbo].[TACGIA] ([MATACGIA], [TENTACGIA], [PHAI]) VALUES (N'0004', N'Serge Gainsbourg', N'Nam')
INSERT [dbo].[TACGIA] ([MATACGIA], [TENTACGIA], [PHAI]) VALUES (N'0005', N'Billy Bland', N'Nữ')
INSERT [dbo].[TACGIA] ([MATACGIA], [TENTACGIA], [PHAI]) VALUES (N'0006', N'Rezső Seress', N'Nam')
INSERT [dbo].[TACGIA] ([MATACGIA], [TENTACGIA], [PHAI]) VALUES (N'0007', N'Francis Lai', N'Nữ')
INSERT [dbo].[TACGIA] ([MATACGIA], [TENTACGIA], [PHAI]) VALUES (N'0008', N'Yoshinori Usui', N'Nữ')
INSERT [dbo].[TACGIA] ([MATACGIA], [TENTACGIA], [PHAI]) VALUES (N'0009', N'Claude Francois', N'Nam')
INSERT [dbo].[TACGIA] ([MATACGIA], [TENTACGIA], [PHAI]) VALUES (N'0010', N'Christophe', N'Nam')

INSERT [dbo].[CAKHUC] ([MACAKHUC], [TENCAKHUC], [THELOAI], [MATACGIA], [THOIGIANSANGTAC]) VALUES (N'0001', N'999 Rose of Love', N'DÂN CA', N'0005', CAST(N'1945-07-25' AS Date))
INSERT [dbo].[CAKHUC] ([MACAKHUC], [TENCAKHUC], [THELOAI], [MATACGIA], [THOIGIANSANGTAC]) VALUES (N'0002', N'Et pourtant', N'TÌNH CA', N'0007', CAST(N'1954-06-23' AS Date))
INSERT [dbo].[CAKHUC] ([MACAKHUC], [TENCAKHUC], [THELOAI], [MATACGIA], [THOIGIANSANGTAC]) VALUES (N'0003', N'The last waltz', N'TRỮ TÌNH', N'0001', CAST(N'1963-01-31' AS Date))
INSERT [dbo].[CAKHUC] ([MACAKHUC], [TENCAKHUC], [THELOAI], [MATACGIA], [THOIGIANSANGTAC]) VALUES (N'0004', N'Hold me for a while', N'TRỮ TÌNH', N'0002', CAST(N'1976-04-30' AS Date))
INSERT [dbo].[CAKHUC] ([MACAKHUC], [TENCAKHUC], [THELOAI], [MATACGIA], [THOIGIANSANGTAC]) VALUES (N'0005', N'Le Pont Mirabeau', N'TIỀN CHIẾN', N'0003', CAST(N'1980-05-25' AS Date))
INSERT [dbo].[CAKHUC] ([MACAKHUC], [TENCAKHUC], [THELOAI], [MATACGIA], [THOIGIANSANGTAC]) VALUES (N'0006', N'Serenade', N'TRỮ TÌNH', N'0004', CAST(N'1990-12-22' AS Date))
INSERT [dbo].[CAKHUC] ([MACAKHUC], [TENCAKHUC], [THELOAI], [MATACGIA], [THOIGIANSANGTAC]) VALUES (N'0007', N'Main dans la main', N'TIỀN CHIẾN', N'0006', CAST(N'2000-01-31' AS Date))
INSERT [dbo].[CAKHUC] ([MACAKHUC], [TENCAKHUC], [THELOAI], [MATACGIA], [THOIGIANSANGTAC]) VALUES (N'0008', N'La Paloma', N'TIỀN CHIẾN', N'0009', CAST(N'1996-02-15' AS Date))
INSERT [dbo].[CAKHUC] ([MACAKHUC], [TENCAKHUC], [THELOAI], [MATACGIA], [THOIGIANSANGTAC]) VALUES (N'0009', N'Yellow bird', N'TRỮ TÌNH', N'0001', CAST(N'1975-04-30' AS Date))
INSERT [dbo].[CAKHUC] ([MACAKHUC], [TENCAKHUC], [THELOAI], [MATACGIA], [THOIGIANSANGTAC]) VALUES (N'0010', N'Le beau Danube bleu', N'TRỮ TÌNH', N'0002', CAST(N'1965-08-29' AS Date))
INSERT [dbo].[LOIVIET] ([MACAKHUC], [TUALOIVIET], [DICHBOI], [THOIGIANDICH]) VALUES (N'0001', N'999 Đóa hoa hồng', N'0005', CAST(N'1950-05-26' AS Date))
INSERT [dbo].[LOIVIET] ([MACAKHUC], [TUALOIVIET], [DICHBOI], [THOIGIANDICH]) VALUES (N'0002', N'Anh vẫn biết', N'0006', CAST(N'2000-08-29' AS Date))
INSERT [dbo].[LOIVIET] ([MACAKHUC], [TUALOIVIET], [DICHBOI], [THOIGIANDICH]) VALUES (N'0003', N'Bài luân vũ mùa mưa', N'0009', CAST(N'2005-07-15' AS Date))
INSERT [dbo].[LOIVIET] ([MACAKHUC], [TUALOIVIET], [DICHBOI], [THOIGIANDICH]) VALUES (N'0004', N'Bình minh mang em đi', N'0007', CAST(N'2010-06-29' AS Date))
INSERT [dbo].[LOIVIET] ([MACAKHUC], [TUALOIVIET], [DICHBOI], [THOIGIANDICH]) VALUES (N'0005', N'Cầu Mirabeau', N'0005', CAST(N'2015-08-30' AS Date))
INSERT [dbo].[LOIVIET] ([MACAKHUC], [TUALOIVIET], [DICHBOI], [THOIGIANDICH]) VALUES (N'0006', N'Dạ khúc', N'0002', CAST(N'2017-04-30' AS Date))
INSERT [dbo].[LOIVIET] ([MACAKHUC], [TUALOIVIET], [DICHBOI], [THOIGIANDICH]) VALUES (N'0007', N'Cho quên đau thương', N'0003', CAST(N'2009-03-31' AS Date))
INSERT [dbo].[LOIVIET] ([MACAKHUC], [TUALOIVIET], [DICHBOI], [THOIGIANDICH]) VALUES (N'0008', N'Cánh buồm xa xưa', N'0010', CAST(N'2001-12-13' AS Date))
INSERT [dbo].[LOIVIET] ([MACAKHUC], [TUALOIVIET], [DICHBOI], [THOIGIANDICH]) VALUES (N'0009', N'Chỉ là giấc mơ', N'0001', CAST(N'2004-05-09' AS Date))
INSERT [dbo].[LOIVIET] ([MACAKHUC], [TUALOIVIET], [DICHBOI], [THOIGIANDICH]) VALUES (N'0010', N'Dòng sông xanh', N'0001', CAST(N'2003-07-21' AS Date))

INSERT [dbo].[TRINHBAY] ([MACAKHUC], [TUALOIVIET], [TENCASI]) VALUES (N'0001', N'999 Đóa hoa hồng', N'Cẩm Ly')
INSERT [dbo].[TRINHBAY] ([MACAKHUC], [TUALOIVIET], [TENCASI]) VALUES (N'0002', N'Anh vẫn biết', N'Elvis Phương')
INSERT [dbo].[TRINHBAY] ([MACAKHUC], [TUALOIVIET], [TENCASI]) VALUES (N'0003', N'Bài luân vũ mùa mưa', N'Ngọc Lan')
INSERT [dbo].[TRINHBAY] ([MACAKHUC], [TUALOIVIET], [TENCASI]) VALUES (N'0004', N'Bình minh mang em đi', N'Đàm Vĩnh Hưng')
INSERT [dbo].[TRINHBAY] ([MACAKHUC], [TUALOIVIET], [TENCASI]) VALUES (N'0005', N'Cầu Mirabeau', N'Tuyết Dung')
INSERT [dbo].[TRINHBAY] ([MACAKHUC], [TUALOIVIET], [TENCASI]) VALUES (N'0006', N'Dạ khúc', N'Lệ Thu')
INSERT [dbo].[TRINHBAY] ([MACAKHUC], [TUALOIVIET], [TENCASI]) VALUES (N'0007', N'Cho quên đau thương', N'Ngọc Lan')
INSERT [dbo].[TRINHBAY] ([MACAKHUC], [TUALOIVIET], [TENCASI]) VALUES (N'0008', N'Cánh buồm xa xưa', N'Duy Quang')
INSERT [dbo].[TRINHBAY] ([MACAKHUC], [TUALOIVIET], [TENCASI]) VALUES (N'0009', N'Chỉ là giấc mơ', N'Thanh Lan')
INSERT [dbo].[TRINHBAY] ([MACAKHUC], [TUALOIVIET], [TENCASI]) VALUES (N'0010', N'Dòng sông xanh', N' Thu Giang')
-- BÀI TẬP TRUY VẤN
--1.CHO BIẾT TÊN CA KHÚC CÓ THỜI GIAN SÁNG TÁC TRƯỚC NĂM 1975
SELECT * 
FROM dbo.CAKHUC AS ck
WHERE YEAR(ck.THOIGIANSANGTAC) < 1975
--2.CHO BIẾT CA KHÚC CÓ NGƯỜI DỊCH LÀ NỮ. SẮP XẾP GIẢM DẦN THEO TÊN CA KHÚC
SELECT *
FROM dbo.TACGIA AS tg JOIN dbo.CAKHUC AS ck ON ck.MATACGIA = tg.MATACGIA 
JOIN dbo.LOIVIET AS lv ON lv.DICHBOI = tg.MATACGIA
WHERE tg.PHAI = N'Nữ'
--3.CHO BIẾT TÊN CA SĨ TRÌNH BÀY NHỮNG CA KHÚC THUỘC THỂ LOẠI 'TRỮ TÌNH'
SELECT *
FROM dbo.TRINHBAY AS tb JOIN dbo.CAKHUC AS ck ON ck.MACAKHUC = tb.MACAKHUC
WHERE ck.THELOAI = N'TRỮ TÌNH'
--4.CHO BIẾT TÁC GIẢ DỊCH CA KHÚC CÓ TỪ 'LOVE'
SELECT * 
FROM dbo.TACGIA AS tg JOIN dbo.CAKHUC ON CAKHUC.MATACGIA = tg.MATACGIA
WHERE TENCAKHUC LIKE '%LOVE'
--5.CHO BIẾT DANH SÁCH CA KHÚC ĐƯỢC DỊCH CÁCH ĐÂY HƠN 10 NĂM.XẾP TĂNG THEO THỂ LOẠI VÀ GIẢM THEO TÊN CAKHUC
SELECT * 
FROM dbo.CAKHUC AS ck JOIN dbo.LOIVIET AS lv ON lv.MACAKHUC = ck.MACAKHUC
WHERE YEAR(lv.THOIGIANDICH) < (YEAR(GETDATE()) - 10)
ORDER BY ck.THELOAI ASC, ck.TENCAKHUC DESC
--6.CHO BIẾT DANH SÁCH CA KHÚC ĐƯỢC ĐÃ ĐƯỢC DỊCH NHƯNG CHƯA CÓ THÔNG TIN NGƯỜI DỊCH
SELECT * 
FROM dbo.CAKHUC AS ck
WHERE ck.MATACGIA = NULL
--7.CHO BIẾT TÊN CA KHÚC, TÊN TÁC GIẢ, TÊN CA SĨ ĐÃ HÁT BÀI HÁT HOẶC THUỘC THỂ LOẠI 'TIỀN CHIẾN' HOĂC ĐƯỢC SÁNG TÁC SAU NĂM 75
SELECT *
FROM dbo.CAKHUC AS ck, dbo.TACGIA AS tg, dbo.TRINHBAY AS tb
WHERE tb.MACAKHUC = ck.MACAKHUC OR ck.THELOAI = N'TIỀN CHIẾN' OR (YEAR(ck.THOIGIANSANGTAC) < 1975)
--8.CHO BIẾT TÊN CA KHÚC CÓ  NGÀY DỊCH TRƯỚC NGÀY SÁNG TÁC
SELECT ck.TENCAKHUC
FROM dbo.CAKHUC AS ck, dbo.LOIVIET AS lv
WHERE lv.THOIGIANDICH < ck.THOIGIANSANGTAC
--9.CHO BIẾT CA SĨ VỪA HÁT NHẠC TRỮ TÌNH VỪA HÁT NHẠC TIỀN CHIẾN
SELECT tb.TENCASI
FROM dbo.TRINHBAY AS tb, dbo.CAKHUC AS ck
WHERE tb.MACAKHUC = ck.MACAKHUC AND (ck.THELOAI = N'TRỮ TÌNH' OR ck.THELOAI = N'TIỀN CHIẾN')
--10.Mã số và tên các tác giả đã chuyển dịch các bài hát do chính tác giả đó sáng tác
SELECT tg.MATACGIA, tg.TENTACGIA
FROM dbo.TACGIA AS tg JOIN dbo.CAKHUC AS ck ON ck.MATACGIA = tg.MATACGIA
JOIN dbo.LOIVIET AS lv ON lv.MACAKHUC = ck.MACAKHUC
WHERE tg.MATACGIA = ck.MATACGIA